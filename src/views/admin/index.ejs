<% mainClass = "" %>
<% page = userName %>

<h1 class="title">Admin panel</h1>

<h2 class="title title--s4">Users</h2>

<table class="table">
  <thead class="table__head">
    <tr class="table__row">
      <th class="table__header">Username</th>
      <% permissionList.forEach(permission => { %>
        <th class="table__header"><%= permission %></th>
      <% }); %>
      <th class="table__header"></th>
    </tr>
  </thead>
  <tbody class="table__body">
    <% users.forEach(user => { %>
      <tr class="table__row">
        <td class="table__data"><%= user.userName %></td>
        <% user.permissionList.forEach(permission => { %>
          <td class="table__data"><%= permission.hasPermission ? "Yes" : "No" %></td>
        <% }); %>
        <% if (user.id !== userId && !user.isHigher) { %>
          <td class="table__data">
            <div class="flex-wrapper">
              <%- include("../components/deleteButtons", { data: user.id, type: "user" }) %>
              <a class="btn btn-primary" href="/admin/users/<%= user.id %>">Edit</a>
            </div>
          </td>
        <% } else { %>
          <td class="table__data"></td>
        <% } %>
      </tr>
    <% }); %>
  </tbody>
</table>

<script>
  document.querySelectorAll(".icon--action-delete-open").forEach(btn => {
    btn.addEventListener("click", () => {
      btn.nextElementSibling.classList.toggle("delete-btns--open");
      btn.parentElement.parentElement.classList.toggle("flex-wrapper--gap");
    });
  });

  document.querySelectorAll(".icon--action-delete-close").forEach(btn => {
    btn.addEventListener("click", () => {
      btn.parentElement.classList.remove("delete-btns--open");
    });
  });

  document.querySelectorAll(".icon--success").forEach(deleteBtn => {
    deleteBtn.addEventListener("click", (event) => {
      event.preventDefault();
      if (deleteBtn.dataset.type === "user") {
        const userId = deleteBtn.dataset.data;
        if (window.confirm("Are you sure you want to delete this user?") === false) return;
        fetch(`/admin/users/${userId}`, {
          method: "DELETE",
          headers: {
            "X-CSRF-TOKEN": "<%= csrfToken %>"
          }
        }).then((response) => {
          if (response.ok) {
            deleteBtn.closest(".table__row").remove();
          } else {
            const error = document.createElement("p");
            error.classList.add("error");
            error.innerText = "Error has occurred";
            deleteBtn.closest(".flex-wrapper").appendChild(error);
            setTimeout(() => {
              error.remove();
            }, 3000);
          }
        });
      }
    });
  });
</script>